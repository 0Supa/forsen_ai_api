<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.58.3/codemirror.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.58.3/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.58.3/mode/lua/lua.min.js"></script>

    <script>
        function logout() {
            document.cookie = "session_id=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
            console.log("cleared cookie")
            location.reload()
        }
        function addChannelPointReward() {
            document.getElementById("add_reward_result").innerText = "Loading..."

            var xmlHttp = new XMLHttpRequest();
            xmlHttp.open("GET", "/add_channel_point_reward/" + document.getElementById("reward_id").value, false); // false for synchronous request
            xmlHttp.send(null);

            document.getElementById("add_reward_result").innerText = xmlHttp.responseText
        }
var editor;
        function updateSettings() {
            document.getElementById("state").innerText = "Updating Settings..."

            var xhr = new XMLHttpRequest();
            xhr.open("POST", "/update_settings", false);

            jsonSettings = {
                "lua_script" : editor.getValue()
            }

            xhr.send(JSON.stringify(jsonSettings));

            document.getElementById("state").innerText = "Settings Updated"
        }
        function loadSettings() {
            var xmlHttp = new XMLHttpRequest();
            xmlHttp.open("GET", "/get_settings", false); // false for synchronous request
            xmlHttp.send(null);

            const res = JSON.parse(xmlHttp.responseText);

            editor.setValue(res["lua_script"])

            document.getElementById("state").textContent = ""
        }
        function addWhitelistEntry(is_add) {
            document.getElementById("update_whitelist_result").innerText = "Updating Whitelist..."

            var xhr = new XMLHttpRequest();
            xhr.open("POST", "/update_whitelist", false);

            jsonSettings = {
                "login": document.getElementById("whitelist_login").value,
                "is_add": is_add,
            }

            xhr.send(JSON.stringify(jsonSettings));

            document.getElementById("update_whitelist_result").innerText = xhr.responseText
        }

        function handleSubmitCard(event) {
            const form = event.currentTarget;
            const url = new URL(form.action) + "/" + document.getElementById("char_name").value;
            const formData = new FormData(form);
            const searchParams = new URLSearchParams(formData);

            const fetchOptions = {
                method: form.method,
                body: formData,
            };

            fetch(url, fetchOptions)
                .then(response => response.text())
                .then(data => {
                    document.getElementById("upload_card_result").innerText = data
                })

            event.preventDefault();
        }
        function handleSubmitVoice(event) {
            const form = event.currentTarget;
            const url = new URL(form.action) + "/" + document.getElementById("voice_char_name").value;
            const formData = new FormData(form);
            const searchParams = new URLSearchParams(formData);

            const fetchOptions = {
                method: form.method,
                body: formData,
            };

            fetch(url, fetchOptions)
                .then(response => response.text())
                .then(data => {
                    document.getElementById("upload_voice_result").innerText = data
                })

            event.preventDefault();
        }
        function handleSubmitModel(event) {
            const form = event.currentTarget;
            const url = new URL(form.action) + "/" + document.getElementById("model_char_name").value;
            const formData = new FormData(form);
            const searchParams = new URLSearchParams(formData);

            const fetchOptions = {
                method: form.method,
                body: formData,
            };

            fetch(url, fetchOptions)
                .then(response => response.text())
                .then(data => {
                    document.getElementById("upload_model_result").innerText = data
                })

            event.preventDefault();
        }
    </script>
</head>
<body>
    <button onclick="logout()">Logout</button>
    <h3>Channel point reward must be created using this button, NOT BY YOURSELF. After adding the reward, you can edit its parameters on twitch website including rewards name, description and prompt.</h3>
    <div><input type="text" id="reward_id"name="reward_id"/><label for="reward_id">Reward ID</label></div>
    <button onclick="addChannelPointReward()">Add Channel Point Reward on your channel</button>
    <div id="add_reward_result"></div>
    <h3>After adding reward, events will come to lua in get_next_event() in reward_id variable. </h3>
    <br>
    <h3>Lua code that will be executed on the server:</h3>
    <textarea id="code-editor"></textarea>
    <script>
        editor = CodeMirror.fromTextArea(document.getElementById('code-editor'), {
                lineNumbers: true,
                mode: 'text/x-lua',
                theme: 'default'
            });
    </script>
    <br>
    <br>
    <button onclick="updateSettings()">Update</button>
    <div id="state">Loading Settings...</div>
    <br>
    <h3>Upload character png card. You can find them here !!NSFW WARNING!! - <a href="https://chub.ai" target="_blank">chub.ai</a> (download png with T sign that says it's compatible with SillyTavern) . Or create card yourself in SillyTavern app.</h3>
    <div><input type="char_name" id="char_name"name="char_name"/><label for="char_name">Character Name</label></div>
    <form id="upload_card" action="/upload_card" method="post" enctype="multipart/form-data">
        <label for="file">File</label>
        <input id="file" name="file" type="file" />
        <button>Upload</button>
    </form>
    <div id="upload_card_result"></div>
    <h3>After uploading you can reference this card in lua code under the name you set above.<br>megumin = get_char_card("megumin")<br>text(megumin.name)</h3>
    <h3>Add a voice for a TTS. Audio must be without music, without long pauses. You can use <a href="https://vocalremover.org/">vocalremover.org</a> to remove music and same site to cut it. </h3>
    <div><input type="voice_char_name" id="voice_char_name"name="voice_char_name"/><label for="voice_char_name">Character Name</label></div>
    <form id="upload_voice" action="/upload_voice" method="post" enctype="multipart/form-data">
        <label for="file">File</label>
        <input id="file" name="file" type="file" />
        <button>Upload</button>
    </form>
    <div id="upload_voice_result"></div>
    <h3>After uploading you can use this voice in tts in lua code under the name you set above.<br>tts("megumin", "You will be exhausted from all the explosions we will do together this night.")</h3>
    <h3>Add a live2d model - must be a .zip file with runtime files(.moc3 or .moc) </h3>
    <div><input type="model_char_name" id="model_char_name"name="model_char_name"/><label for="model_char_name">Model Character Name</label></div>
    <form id="upload_model" action="/upload_model" method="post" enctype="multipart/form-data">
        <label for="file">File</label>
        <input id="file" name="file" type="file" />
        <button>Upload</button>
    </form>
    <div id="upload_model_result"></div>
    <script>
        upload_char_form = document.getElementById('upload_card');
        upload_char_form.addEventListener('submit', handleSubmitCard);
        upload_voice_form = document.getElementById('upload_voice');
        upload_voice_form.addEventListener('submit', handleSubmitVoice);
        upload_model_form = document.getElementById('upload_model');
        upload_model_form.addEventListener('submit', handleSubmitModel);
        loadSettings()
    </script>
    <br>
    <div>Update whitelist:</div>
    <input type="text" id="whitelist_login"/>
    <button onclick="addWhitelistEntry(true)">Add To Whitelist</button>
    <button onclick="addWhitelistEntry(false)">Ban</button>
    <output id="update_whitelist_result"></output>
    <h3>Want to reset lua code back to default? Make editor empty and press update and then reload the page.</h3>
</body>
</html>
